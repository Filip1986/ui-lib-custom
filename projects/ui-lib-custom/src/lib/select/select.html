<div [class]="hostClasses()">
  @if (label()) {
    <label class="ui-select-label" [attr.id]="labelId()">
      <span>{{ label() }}</span>
    </label>
  }

  <div class="ui-select-control" #controlEl (click)="togglePanel()">
    <div class="ui-select-value" [class.ui-select-placeholder]="!displayValue()">
      @if (displayValue()) {
        {{ displayValue() }}
      } @else {
        {{ placeholder() }}
      }
    </div>
    <div class="ui-select-actions">
      @if (loading()) {
        <span class="ui-select-spinner"></span>
      }
      @if (displayValue()) {
        <button
          type="button"
          class="ui-select-clear"
          (click)="$event.stopPropagation(); clear()"
          aria-label="Clear selection"
        >
          ×
        </button>
      }
      <span class="ui-select-arrow">▾</span>
    </div>
  </div>

  @if (open()) {
    <div
      class="ui-select-panel"
      #panel
      [id]="listboxId()"
      role="listbox"
      [attr.aria-label]="placeholder()"
      [attr.aria-multiselectable]="multiple() ? 'true' : null"
    >
      @if (searchable()) {
        <div class="ui-select-search">
          <input
            #inputEl
            type="text"
            [value]="filter()"
            (input)="onFilter($any($event.target).value)"
            placeholder="Search..."
            aria-label="Search options"
          />
        </div>
      }

      @for (groupKey of groupKeys(); track groupKey) {
        @if (groupKey !== '__ungrouped') {
          <div class="ui-select-group">{{ groupKey }}</div>
        }
        @for (opt of groupedOptions()[groupKey]; track opt.label + opt.value) {
          <div
            class="ui-select-option"
            [id]="controlId() + '-option-' + optionIndex(opt)"
            [class.ui-select-option--active]="optionIndex(opt) === focusedIndex()"
            [class.ui-select-option--selected]="isSelected(opt)"
            [class.ui-select-option--disabled]="opt.disabled"
            [class.selected]="isSelected(opt)"
            [class.disabled]="opt.disabled"
            (click)="selectOption(opt)"
            (mouseenter)="setActiveIndex(optionIndex(opt))"
            role="option"
            [attr.aria-selected]="isSelected(opt)"
            [attr.aria-disabled]="opt.disabled ? 'true' : null"
          >
            @if (optionTemplate()) {
              <ng-container
                *ngTemplateOutlet="optionTemplate(); context: { $implicit: opt }"
              ></ng-container>
            } @else {
              <span>{{ opt.label }}</span>
            }
          </div>
        }
      }

      @if (filteredOptions().length === 0) {
        <div class="ui-select-empty">No results</div>
      }
    </div>
  }
</div>
